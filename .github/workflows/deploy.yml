name: ğŸš€ Deploy FastAPI to Server

on:
  push:
    branches:
      - main

jobs: 
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install paramiko scp

      - name: ğŸš€ Run deployment script
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}  # Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
        run: |
          python <<EOF
          import paramiko
          import os
          import sys

          host = os.getenv("SERVER_IP")
          user = os.getenv("SERVER_USER")
          key = os.getenv("SSH_PRIVATE_KEY")

          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ĞºĞ»ÑÑ‡ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
          key_path = "/tmp/deploy_key"
          with open(key_path, "w") as f:
              f.write(key)
              f.write("\n")
          os.chmod(key_path, 0o600)

          # ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ SSH Ñ ĞºĞ»ÑÑ‡Ğ¾Ğ¼
          ssh = paramiko.SSHClient()
          ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
          try:
              ssh.connect(hostname=host, username=user, key_filename=key_path, timeout=10)
          except Exception as e:
              print(f"âŒ SSH connection failed: {e}")
              sys.exit(1)

          # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
          command = '''
          set -e  # Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
          cd /root/promo_backend || { echo "âŒ Directory not found"; exit 1; }

          echo "ğŸ” Pulling latest code..."
          git pull origin main || { echo "âŒ Git pull failed"; exit 1; }

          echo "ğŸ“¦ Activating virtual environment..."
          if [ ! -f "venv/bin/activate" ]; then
              echo "âŒ Virtual environment not found. Run: python -m venv venv"
              exit 1
          fi
          source venv/bin/activate

          echo "ğŸ”„ Upgrading pip..."
          pip install --upgrade pip --no-cache-dir || exit 1

          if [ -f "requirements.txt" ]; then
              echo "ğŸ“¥ Installing requirements..."
              pip install -r requirements.txt --no-cache-dir || { echo "âŒ Pip install failed"; exit 1; }
          fi

          echo "ğŸ”„ Restarting FastAPI service..."
          systemctl restart fastapi || { echo "âŒ Failed to restart service"; exit 1; }

          echo "âœ… Deployment successful!"
          '''

          stdin, stdout, stderr = ssh.exec_command(command)
          out = stdout.read().decode()
          err = stderr.read().decode()

          print("STDOUT:")
          print(out)
          print("STDERR:")
          print(err)

          if stderr.channel.recv_exit_status() != 0:
              print("âŒ Deployment failed!")
              sys.exit(1)

          ssh.close()
          EOF

