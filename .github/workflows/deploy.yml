name: ğŸš€ Deploy FastAPI to Server

on:
  push:
    branches:
      - main  # Ğ¸Ğ»Ğ¸ Ğ»ÑĞ±Ğ°Ñ Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ğ²ĞµÑ‚ĞºĞ°

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install paramiko for SSH
        run: |
          pip install paramiko scp

      - name: ğŸš€ Run deployment script
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          python <<'EOF'
          import os, sys, tarfile, tempfile, pathlib
          import paramiko

          # --- Inputs from secrets (ĞºĞ°Ğº Ñƒ Ñ‚ĞµĞ±Ñ Ğ±Ñ‹Ğ»Ğ¾) ---
          host = os.getenv("SERVER_IP")
          user = os.getenv("SERVER_USER")
          password = os.getenv("SERVER_PASSWORD")

          if not all([host, user, password]):
            print("Missing SERVER_IP / SERVER_USER / SERVER_PASSWORD envs", file=sys.stderr)
            sys.exit(1)

          # --- Archive current repo (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¼ÑƒÑĞ¾Ñ€) ---
          workspace = os.getenv("GITHUB_WORKSPACE", ".")
          workspace_path = pathlib.Path(workspace)
          archive_local = pathlib.Path(tempfile.gettempdir()) / "release.tar.gz"

          exclude_names = {".git", ".github", "venv", "__pycache__", "tests"}
          def should_include(path: pathlib.Path) -> bool:
            # Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ¸/Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ğ¾ Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¼ Ğ¸Ğ¼ĞµĞ½Ğ°Ğ¼ Ğ¸ __pycache__ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€ĞµĞ²ÑŒÑÑ…
            parts = set(path.parts)
            if any(p in exclude_names for p in parts):
              return False
            return True

          with tarfile.open(archive_local, "w:gz") as tar:
            for root, dirs, files in os.walk(workspace_path):
              # Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° Ğ»ĞµÑ‚Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ·Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ²Ğ½ÑƒÑ‚Ñ€ÑŒ
              dirs[:] = [d for d in dirs if should_include(pathlib.Path(root, d))]
              for f in files:
                fp = pathlib.Path(root, f)
                if should_include(fp):
                  tar.add(fp, arcname=str(fp.relative_to(workspace_path)))

          print(f"Created archive: {archive_local}")

          # --- SSH + SFTP upload ---
          ssh = paramiko.SSHClient()
          ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
          ssh.connect(hostname=host, username=user, password=password, timeout=30)

          sftp = ssh.open_sftp()
          remote_archive = "/tmp/release.tar.gz"
          sftp.put(str(archive_local), remote_archive)
          sftp.close()
          print(f"Uploaded archive to {remote_archive}")

          # --- Remote deploy script (Ğ±ĞµĞ· git pull) ---
          remote_cmd = r'''
          set -euo pipefail

          export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

          APP_DIR="/root/promo_backend"
          SERVICE="fastapi"

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ´Ğ¸Ğ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ¾Ğ´ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¾Ñ‚Ğ´Ğ°Ğ´Ğ¸Ğ¼ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ÑŒÑ†Ñƒ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¼Ñƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
          mkdir -p "$APP_DIR"
          chown -R "$USER":"$USER" "$APP_DIR"

          # Ğ Ğ°ÑĞ¿Ğ°ĞºÑƒĞµĞ¼ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¿Ğ°Ğ¿ĞºÑƒ, Ğ·Ğ°Ñ‚ĞµĞ¼ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼
          TMP_DIR="$(mktemp -d /tmp/promo_release_XXXX)"
          tar -xzf /tmp/release.tar.gz -C "$TMP_DIR"

          # Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ ĞµÑÑ‚ÑŒ venv
          if [ ! -d "$APP_DIR/venv" ]; then
            python3 -m venv "$APP_DIR/venv"
          fi

          # Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ´Ğ° (Ğ±ĞµÑ€ĞµĞ¶Ñ‘Ğ¼ venv)
          if command -v rsync >/dev/null 2>&1; then
            rsync -a --delete --exclude 'venv' "$TMP_DIR"/ "$APP_DIR"/
          else
            # ĞµÑĞ»Ğ¸ rsync Ğ½ĞµÑ‚ â€” ÑƒĞ´Ğ°Ğ»Ğ¸Ğ¼ Ğ²ÑÑ‘, ĞºÑ€Ğ¾Ğ¼Ğµ venv, Ğ¸ ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼
            find "$APP_DIR" -mindepth 1 -maxdepth 1 ! -name 'venv' -exec rm -rf {} +
            cp -a "$TMP_DIR"/. "$APP_DIR"/
          fi

          # Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
          . "$APP_DIR/venv/bin/activate"
          python -m pip install --upgrade pip wheel
          if [ -f "$APP_DIR/requirements.txt" ]; then
            pip install --no-cache-dir -r "$APP_DIR/requirements.txt"
          fi

          # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº systemd-ÑĞ½Ğ¸Ñ‚Ğ°
          systemctl daemon-reload
          systemctl restart "$SERVICE"
          systemctl status "$SERVICE" --no-pager --full

          # Ğ£Ğ±Ğ¾Ñ€ĞºĞ°
          rm -rf "$TMP_DIR"
          rm -f /tmp/release.tar.gz
          '''

          # Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ğ¼ Ñ‡ĞµÑ€ĞµĞ· bash -lc, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ±Ñ‹Ğ»Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
          stdin, stdout, stderr = ssh.exec_command(
          "bash -lc 'cat >/tmp/deploy.sh; bash /tmp/deploy.sh'",
              get_pty=True
          )
          stdin.write(remote_cmd)
          stdin.channel.shutdown_write()
          
          out, err = stdout.read().decode(), stderr.read().decode()
          code = stdout.channel.recv_exit_status()
          print(out)
          if err.strip():
              print(err, file=sys.stderr)
          ssh.close()
          sys.exit(code)
          EOF
